<!-- templates/admin_adopt_requests.html -->
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Adoption Requests - Admin</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/admin_adopt_request.css') }}">
    <script>
        function removeRequest(event, form) {
            event.preventDefault();
            const btn = form.querySelector("button");
            btn.disabled = true;

            fetch(form.action, {
                method: "POST",
                body: new FormData(form)
            })
            .then(res => {
                if (res.ok) {
                    form.closest("tr").remove();
                } else {
                    alert("Action failed!");
                    btn.disabled = false;
                }
            })
            .catch(err => {
                console.error(err);
                alert("Error occurred!");
                btn.disabled = false;
            });
        }

        document.addEventListener("DOMContentLoaded", () => {
            const modal = document.getElementById("petDetailModal");
            const close = modal.querySelector(".close");

            document.querySelectorAll(".view-btn").forEach(btn => {
                btn.addEventListener("click", () => {
                    document.getElementById("modal-image").src = btn.dataset.image || "";
                    document.getElementById("modal-name").textContent = btn.dataset.name;
                    document.getElementById("modal-type").textContent = btn.dataset.type;
                    document.getElementById("modal-breed").textContent = btn.dataset.breed;
                    document.getElementById("modal-location").textContent = btn.dataset.location;
                    document.getElementById("modal-gender").textContent = btn.dataset.gender;
                    document.getElementById("modal-description").textContent = btn.dataset.description;
                    document.getElementById("modal-reason").textContent = btn.dataset.reason;
                    document.getElementById("modal-address").textContent = btn.dataset.address;
                    document.getElementById("modal-contact").textContent = btn.dataset.contact;
                    modal.style.display = "block";
                });
            });

            close.onclick = () => modal.style.display = "none";
            window.onclick = (e) => { if(e.target == modal) modal.style.display = "none"; };
        });
    </script>
</head>
<body>
    <div class="container">
        <header class="dashboard-header">
            <h2>Adoption Requests</h2>
            <a href="{{ url_for('admin_home') }}" class="back-btn">‚Üê Back to Dashboard</a>
        </header>

        {% if pets %}
        <table>
            <thead>
                <tr>
                    <th>Pet Image</th>
                    <th>Pet Name</th>
                    <th>Type</th>
                    <th>Breed</th>
                    <th>Requested By</th>
                    <th>Action</th>
                </tr>
            </thead>
            <tbody>
                {% for item in pets %}
                    {% if item.requests %}
                        {% for req, user_name, user_email in item.requests %}
                        <tr>
                            <td><img src="{{ url_for('static', filename='uploads/' + item.image) if item.image else url_for('static', filename='images/default_pet.png') }}" class="pet-img" alt="Pet"></td>
                            <td>{{ item.name }}</td>
                            <td>{{ item.type }}</td>
                            <td>{{ item.breed }}</td>
                            <td>{{ user_name }} ({{ user_email }})</td>
                            <td>
                                <button class="action-btn view-btn"
                                    data-name="{{ item.name }}"
                                    data-type="{{ item.type }}"
                                    data-breed="{{ item.breed }}"
                                    data-location="{{ item.location }}"
                                    data-gender="{{ item.gender }}"
                                    data-description="{{ item.description }}"
                                    data-image="{{ url_for('static', filename='uploads/' + item.image) if item.image else '' }}"
                                    data-reason="{{ req.reason }}"
                                    data-address="{{ req.address }}"
                                    data-contact="{{ req.mobile }}">
                                    View
                                </button>

                                {% if req.status == 'pending' %}
                                    <form method="POST" action="{{ url_for('update_adopt_request', req_id=req.id, action='approve') }}" onsubmit="removeRequest(event, this);" style="display:inline;">
                                        <button type="submit" class="action-btn approve-btn">Approve</button>
                                    </form>
                                    <form method="POST" action="{{ url_for('update_adopt_request', req_id=req.id, action='reject') }}" onsubmit="removeRequest(event, this);" style="display:inline;">
                                        <button type="submit" class="action-btn reject-btn">Reject</button>
                                    </form>
                                {% else %}
                                    {% if req.status == 'approved' %}
                                        <span style="color:green; font-weight:600;">Adopted</span>
                                    {% elif req.status == 'rejected' %}
                                        <span style="color:red; font-weight:600;">Rejected</span>
                                    {% endif %}
                                {% endif %}
                            </td>
                        </tr>
                        {% endfor %}
                    {% endif %}
                {% endfor %}
            </tbody>
        </table>
        {% else %}
        <p>No adoption requests found.</p>
        {% endif %}
    </div>

    <!-- Modal -->
    <div id="petDetailModal" class="modal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <img id="modal-image" src="" alt="Pet Image">
            <h2 id="modal-name"></h2>
            <p><strong>Type:</strong> <span id="modal-type"></span></p>
            <p><strong>Breed:</strong> <span id="modal-breed"></span></p>
            <p><strong>Location:</strong> <span id="modal-location"></span></p>
            <p><strong>Gender:</strong> <span id="modal-gender"></span></p>
            <p><strong>Description:</strong> <span id="modal-description"></span></p>
            <hr>
            <p><strong>Reason for Adoption:</strong> <span id="modal-reason"></span></p>
            <p><strong>Address:</strong> <span id="modal-address"></span></p>
            <p><strong>Contact:</strong> <span id="modal-contact"></span></p>
        </div>
    </div>
</body>
</html>