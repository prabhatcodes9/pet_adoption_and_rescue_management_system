<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pet Admin Dashboard</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/admin_adopt.css') }}">
    <script>
    function removeRequestCard(event, form) {
        event.preventDefault();

        // Disable both buttons inside the same request-card immediately
        const buttons = form.closest('.request-card').querySelectorAll('button');
        buttons.forEach(btn => {
            btn.disabled = true;
            btn.style.opacity = '0.6';
            btn.style.cursor = 'not-allowed';
        });

        fetch(form.action, {
            method: 'POST',
            body: new FormData(form)
        })
        .then(() => {
            // Remove request card after server confirms
            form.closest('.request-card').remove();
        })
        .catch(() => {
            // If fetch fails, re-enable buttons
            buttons.forEach(btn => {
                btn.disabled = false;
                btn.style.opacity = '1';
                btn.style.cursor = 'pointer';
            });
        });
    }

    function showSection(section) {
        const sections = document.querySelectorAll('.pet-grid');
        sections.forEach(s => s.classList.remove('show'));
        document.getElementById(section).classList.add('show');

        const cards = document.querySelectorAll('.status-card');
        cards.forEach(c => c.classList.remove('active'));
        document.querySelector(`.status-card[data-section="${section}"]`).classList.add('active');
    }

    // Default section
    document.addEventListener('DOMContentLoaded', () => showSection('pending'));
</script>
    
</head>
<body>
<div class="container">
    <header class="dashboard-header">
        <h1>Pet Admin Dashboard</h1>
        <p>Manage adoption requests</p>
        <a href="{{ url_for('admin_dashboard') }}" class="back-btn">‚Üê Back to Dashboard</a>
    </header>

    <!-- Status Tabs -->
    <div class="status-cards">
        <div class="status-card active" data-section="pending" onclick="showSection('pending')">
            <h3>Pending</h3>
            <span>{{ pending_count }}</span>
        </div>
        <div class="status-card" data-section="adopted" onclick="showSection('adopted')">
            <h3>Adopted</h3>
            <span>{{ adopted_count }}</span>
        </div>
    </div>

    <!-- Pending Pets Section -->
    <div class="pet-grid" id="pending">
        {% set pending_pets = pet_data | selectattr("pet.status", "equalto", "pending") | list %}
        {% if pending_pets %}
            {% for item in pending_pets %}
                <div class="pet-card">
                    <img src="{{ url_for('static', filename='uploads/' + (item.pet.image or 'default.png')) }}" alt="{{ item.pet.pet_name }}">
                    <h3>{{ item.pet.pet_name }}</h3>
                    <p><strong>Type:</strong> {{ item.pet.pet_type }}</p>
                    <p><strong>Breed:</strong> {{ item.pet.breed or 'N/A' }}</p>
                    <p><strong>Age:</strong> {{ item.pet.age or 'N/A' }}</p>
                    <p><strong>Gender:</strong> {{ item.pet.gender or 'N/A' }}</p>
                    <p><strong>Description:</strong> {{ item.pet.description or 'N/A' }}</p>
                    <p><strong>Location:</strong> {{ item.pet.location or 'N/A' }}</p>
                    <p><strong>Mobile:</strong> {{ item.pet.mobile or 'N/A' }}</p>
                    <p><strong>Status:</strong> <span class="status-badge pending">Pending</span></p>

                    <div class="requests-section">
                        <h4>Adoption Requests</h4>
                        {% if item.requests %}
                            {% for req, user_name, user_email in item.requests %}
                                <div class="request-card">
                                    <p><strong>Requested By:</strong> {{ user_name }} ({{ user_email }})</p>
                                    <p><strong>Reason:</strong> {{ req.reason }}</p>
                                    <p><strong>Contact:</strong> {{ req.mobile }}</p>
                                    <p><strong>Address:</strong> {{ req.address }}</p>

                                    {% if req.status == 'pending' %}
                                        <form method="POST" action="{{ url_for('update_adopt_request', req_id=req.id, action='approve') }}" onsubmit="removeRequestCard(event, this);" style="display:inline;">
                                            <button type="submit" class="approve-btn">‚úÖ Approve</button>
                                        </form>
                                        <form method="POST" action="{{ url_for('update_adopt_request', req_id=req.id, action='reject') }}" onsubmit="removeRequestCard(event, this);" style="display:inline;">
                                            <button type="submit" class="reject-btn">‚ùå Reject</button>
                                        </form>
                                    {% else %}
                                        <p><strong>Status:</strong>
                                            {% if req.status == 'approved' %}
                                                <span style="color:green;">Adopted</span>
                                            {% elif req.status == 'rejected' %}
                                                <span style="color:red;">Rejected</span>
                                            {% endif %}
                                        </p>
                                    {% endif %}
                                </div>
                            {% endfor %}
                        {% else %}
                            <p>No adoption requests yet.</p>
                        {% endif %}
                    </div>

                    <div class="pet-actions">
                        <form action="{{ url_for('delete_adopt_pet', pet_id=item.pet.id) }}" method="POST" onsubmit="return confirm('Are you sure you want to delete this pet?');">
                            <button type="submit" class="delete-btn">üóëÔ∏è Delete</button>
                        </form>
                    </div>
                </div>
            {% endfor %}
        {% else %}
            <p>No pending pets found.</p>
        {% endif %}
    </div>

    <!-- Adopted Pets Section -->
    <div class="pet-grid" id="adopted">
        {% set adopted_pets = pet_data | selectattr("pet.status", "equalto", "adopted") | list %}
        {% if adopted_pets %}
            {% for item in adopted_pets %}
                <div class="pet-card">
                    <img src="{{ url_for('static', filename='uploads/' + (item.pet.image or 'default.png')) }}" alt="{{ item.pet.pet_name }}">
                    <h3>{{ item.pet.pet_name }}</h3>
                    <p><strong>Type:</strong> {{ item.pet.pet_type }}</p>
                    <p><strong>Breed:</strong> {{ item.pet.breed or 'N/A' }}</p>
                    <p><strong>Age:</strong> {{ item.pet.age or 'N/A' }}</p>
                    <p><strong>Gender:</strong> {{ item.pet.gender or 'N/A' }}</p>
                    <p><strong>Description:</strong> {{ item.pet.description or 'N/A' }}</p>
                    <p><strong>Location:</strong> {{ item.pet.location or 'N/A' }}</p>
                    <p><strong>Mobile:</strong> {{ item.pet.mobile or 'N/A' }}</p>
                    <p><strong>Status:</strong> <span class="status-badge adopted">Adopted</span></p>

                                <div class="pet-actions">
                        <form action="{{ url_for('delete_adopt_pet', pet_id=item.pet.id) }}" method="POST" onsubmit="return confirm('Are you sure you want to delete this pet?');">
                            <button type="submit" class="delete-btn">üóëÔ∏è Delete</button>
                        </form>
            </div>
                </div>
            {% endfor %}
        {% else %}
            <p>No adopted pets found.</p>
        {% endif %}
    </div>
</div>
</body>
</html>
